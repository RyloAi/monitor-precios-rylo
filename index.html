<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Precios - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); }
        .severity-high   { background: rgba(239,68,68,0.2);   color: #f87171; border: 1px solid rgba(239,68,68,0.4); }
        .severity-medium { background: rgba(245,158,11,0.2);  color: #fbbf24; border: 1px solid rgba(245,158,11,0.4); }
        .severity-low    { background: rgba(16,185,129,0.2);  color: #34d399; border: 1px solid rgba(16,185,129,0.4); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #3b82f6; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .logo-container { width:48px; height:48px; border-radius:12px; background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(139,92,246,0.1)); border:1px solid rgba(59,130,246,0.2); display:flex; align-items:center; justify-content:center; padding:6px; position:relative; overflow:hidden; }
        .logo-container::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(139,92,246,0.2)); opacity:0; transition:opacity 0.3s; }
        .logo-container:hover::before { opacity:1; }
        .logo-img { width:100%; height:100%; object-fit:contain; position:relative; z-index:1; filter:drop-shadow(0 0 8px rgba(139,92,246,0.4)); }
        .logo-fallback { display:none; width:100%; height:100%; align-items:center; justify-content:center; color:#60a5fa; font-weight:bold; font-size:20px; position:relative; z-index:1; }
        .link-btn { display:inline-flex; align-items:center; gap:4px; color:#60a5fa; font-size:11px; padding:2px 8px; border-radius:4px; border:1px solid rgba(96,165,250,0.3); background:rgba(96,165,250,0.05); transition:all 0.15s; white-space:nowrap; }
        .link-btn:hover { background:rgba(96,165,250,0.15); border-color:rgba(96,165,250,0.6); }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <header class="sticky top-0 z-50 bg-slate-900/90 backdrop-blur-md border-b border-slate-800">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="logo-container">
                        <img src="logo-rylo.png" alt="Rylo" class="logo-img"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="logo-fallback">R</div>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <h1 class="font-bold text-xl text-white tracking-tight">Monitor de Precios</h1>
                            <span class="px-2 py-0.5 rounded-full bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/20 text-[10px] font-semibold text-blue-400 uppercase tracking-wider">Rylo</span>
                        </div>
                        <p class="text-xs text-slate-400">Control de infractores - Mercado Libre</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="loadData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium text-white transition-all shadow-lg shadow-blue-600/20 flex items-center gap-2 active:scale-95">
                        <i class="fas fa-sync-alt" id="refresh-icon"></i>
                        <span class="hidden sm:inline">Actualizar Datos</span>
                    </button>
                    <div class="text-right hidden sm:block">
                        <p class="text-xs text-slate-400">Última actualización</p>
                        <p class="text-sm font-medium text-white font-mono" id="last-update">--</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">

        <div id="loading-state" class="hidden flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="text-slate-400">Cargando datos desde Google Sheets...</p>
        </div>

        <div id="error-state" class="hidden glass-panel rounded-2xl p-8 text-center border border-red-500/30">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <h3 class="text-lg font-semibold text-white mb-2">Error al cargar datos</h3>
            <p class="text-slate-400 mb-2" id="error-message"></p>
            <p class="text-slate-500 text-xs mb-4">Verificá que el Sheet esté publicado: Archivo → Compartir → Publicar en la web → Hoja "Data" → CSV</p>
            <button onclick="loadData()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">Reintentar</button>
        </div>

        <div id="dashboard-content" class="space-y-6">

            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 fade-in">
                <div class="glass-panel rounded-2xl p-6 hover-lift border border-slate-700/50">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-400 text-sm font-medium mb-1">Total Infracciones</p>
                            <h3 class="text-3xl font-bold text-white" id="kpi-total">--</h3>
                        </div>
                        <div class="w-10 h-10 bg-red-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-circle text-red-400"></i>
                        </div>
                    </div>
                    <span class="text-slate-500 text-sm">registros activos</span>
                </div>
                <div class="glass-panel rounded-2xl p-6 hover-lift border border-slate-700/50">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-400 text-sm font-medium mb-1">Tiendas Infractoras</p>
                            <h3 class="text-3xl font-bold text-white" id="kpi-stores">--</h3>
                        </div>
                        <div class="w-10 h-10 bg-orange-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-store text-orange-400"></i>
                        </div>
                    </div>
                    <span class="text-slate-500 text-sm">vendedores únicos</span>
                </div>
                <div class="glass-panel rounded-2xl p-6 hover-lift border border-slate-700/50">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-400 text-sm font-medium mb-1">Productos Afectados</p>
                            <h3 class="text-3xl font-bold text-white" id="kpi-products">--</h3>
                        </div>
                        <div class="w-10 h-10 bg-amber-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-box text-amber-400"></i>
                        </div>
                    </div>
                    <span class="text-slate-500 text-sm">diferentes SKU</span>
                </div>
                <div class="glass-panel rounded-2xl p-6 hover-lift border border-slate-700/50">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-400 text-sm font-medium mb-1">Diferencia Promedio</p>
                            <h3 class="text-3xl font-bold text-white" id="kpi-diff">--%</h3>
                        </div>
                        <div class="w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-percentage text-emerald-400"></i>
                        </div>
                    </div>
                    <span class="text-slate-500 text-sm">por debajo del mínimo</span>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in" style="animation-delay:0.1s">
                <div class="glass-panel rounded-2xl p-6 border border-slate-700/50">
                    <h3 class="text-lg font-semibold text-white mb-1">Top 10 Tiendas Infractoras</h3>
                    <p class="text-sm text-slate-400 mb-4">Por cantidad de infracciones</p>
                    <div class="h-64"><canvas id="storesChart"></canvas></div>
                </div>
                <div class="glass-panel rounded-2xl p-6 border border-slate-700/50">
                    <h3 class="text-lg font-semibold text-white mb-1">Productos Más Infringidos</h3>
                    <p class="text-sm text-slate-400 mb-4">Por volumen de infracciones</p>
                    <div class="h-64"><canvas id="productsChart"></canvas></div>
                </div>
            </div>

            <!-- Severidad + Alertas -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in" style="animation-delay:0.2s">
                <div class="glass-panel rounded-2xl p-6 border border-slate-700/50">
                    <h3 class="text-lg font-semibold text-white mb-4">Distribución por Severidad</h3>
                    <div class="h-48 flex items-center justify-center">
                        <canvas id="severityChart"></canvas>
                    </div>
                    <div class="mt-4 space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span>Crítico (&gt;20%)</span>
                            <span class="font-semibold text-white" id="count-critical">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-amber-500"></span>Medio (10-20%)</span>
                            <span class="font-semibold text-white" id="count-medium">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span>Bajo (&lt;10%)</span>
                            <span class="font-semibold text-white" id="count-low">0</span>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 glass-panel rounded-2xl p-6 border border-slate-700/50">
                    <h3 class="text-lg font-semibold text-white mb-4">Alertas Críticas</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto" id="alerts-container">
                        <p class="text-slate-500 text-sm">Cargando...</p>
                    </div>
                </div>
            </div>

            <!-- Tabla -->
            <div class="glass-panel rounded-2xl overflow-hidden border border-slate-700/50 fade-in" style="animation-delay:0.3s">
                <div class="p-6 border-b border-slate-700/50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-white">Detalle de Infracciones</h3>
                        <p class="text-sm text-slate-400">Listado completo · click en "Ver" para abrir la publicación</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="text" id="search-input" placeholder="Buscar tienda o producto..."
                               class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 w-full md:w-64"
                               onkeyup="filterTable()">
                        <select id="filter-severity" onchange="filterTable()"
                                class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500">
                            <option value="all">Todas</option>
                            <option value="high">Críticas</option>
                            <option value="medium">Medias</option>
                            <option value="low">Bajas</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800/80 text-slate-400 sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-3 font-medium cursor-pointer hover:text-white" onclick="sortTable('tienda')">Tienda <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 font-medium cursor-pointer hover:text-white" onclick="sortTable('producto')">Producto <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 font-medium text-right cursor-pointer hover:text-white" onclick="sortTable('precioMin')">Precio Mín <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 font-medium text-right cursor-pointer hover:text-white" onclick="sortTable('precioVenta')">Precio Venta <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 font-medium text-right cursor-pointer hover:text-white" onclick="sortTable('diferencia')">Diferencia <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 font-medium text-center">Severidad</th>
                                <th class="px-6 py-3 font-medium text-center">Publicación</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800" id="table-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        // ============================================================
        // CONFIGURACIÓN
        // Publicá la hoja "Data" como CSV en Google Sheets y pegá la URL acá:
        // Archivo → Compartir → Publicar en la web → elegí hoja "Data" → CSV
        // ============================================================
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR9CFEP45lmbJIpOW_SM5cjYDtPFbLNA4M2lUJZw61EzSaGuq_BAvfS9tc0Py0sJWB8QcQOylGVoiX4/pub?output=csv';

        let allData = [];
        let charts = {};
        let sortState = { column: null, asc: true };

        // ============================================================
        // CSV Parser robusto
        // ============================================================
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) throw new Error('El CSV está vacío');

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
            console.log('Headers detectados:', headers);

            // Índices de columnas — coinciden con la hoja Data
            const idx = {
                tienda:      headers.findIndex(h => h.includes('tienda') || h.includes('store') || h.includes('vendedor')),
                producto:    headers.findIndex(h => h.includes('producto') || h.includes('product') || h.includes('sku') || h.includes('item')),
                precioMin:   headers.findIndex(h => h.includes('mínimo') || h.includes('minimo') || h.includes('min')),
                precioVenta: headers.findIndex(h => (h.includes('precio') && h.includes('venta')) || h.includes('sale') || h.includes('venta')),
                link:        headers.findIndex(h => h.includes('link') || h.includes('url') || h.includes('publicaci')),
                id:          headers.findIndex(h => h === 'id' || h.includes('mla')),
            };
            console.log('Índices columnas:', idx);

            if (idx.tienda === -1 || idx.precioMin === -1 || idx.precioVenta === -1)
                throw new Error('No se encontraron las columnas esperadas. Headers: ' + headers.join(', '));

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                // Split CSV respetando comillas
                const values = [];
                let inQ = false, cur = '';
                for (const ch of lines[i]) {
                    if (ch === '"') { inQ = !inQ; }
                    else if (ch === ',' && !inQ) { values.push(cur.trim().replace(/^"|"$/g, '')); cur = ''; }
                    else { cur += ch; }
                }
                values.push(cur.trim().replace(/^"|"$/g, ''));

                const get = (i) => (i >= 0 ? values[i] || '' : '');

                const precioMin   = parseFloat(get(idx.precioMin).replace(',', '.'))   || 0;
                const precioVenta = parseFloat(get(idx.precioVenta).replace(',', '.')) || 0;

                if (precioMin === 0 && precioVenta === 0) continue; // saltar filas sin precios

                // Calcular diferencia y % directamente (no depende del Sheet)
                const diferencia  = precioVenta - precioMin;                     // negativo = por debajo
                const porcentaje  = precioMin > 0 ? Math.abs(diferencia / precioMin) * 100 : 0;

                // Extraer URL del HYPERLINK si viene como fórmula, o usarlo directo
                let linkRaw = get(idx.link);
                let linkUrl = '';
                const match = linkRaw.match(/HYPERLINK\("([^"]+)"/i);
                if (match) linkUrl = match[1];
                else if (linkRaw.startsWith('http')) linkUrl = linkRaw;

                // Si no hay link pero hay ID, construirlo
                const id = get(idx.id);
                if (!linkUrl && id) {
                    const cleanId = id.replace('MLA', 'MLA-');
                    linkUrl = `https://articulo.mercadolibre.com.ar/${cleanId}`;
                }

                data.push({
                    tienda:      get(idx.tienda)   || '(sin nombre)',
                    producto:    get(idx.producto) || '(sin producto)',
                    precioMin,
                    precioVenta,
                    diferencia,
                    porcentaje,
                    link: linkUrl,
                    id
                });
            }

            if (data.length === 0) throw new Error('No se encontraron filas con datos válidos');
            return data;
        }

        // ============================================================
        // Carga de datos
        // ============================================================
        async function loadData() {
            const loadingEl   = document.getElementById('loading-state');
            const errorEl     = document.getElementById('error-state');
            const contentEl   = document.getElementById('dashboard-content');
            const refreshIcon = document.getElementById('refresh-icon');

            refreshIcon.classList.add('fa-spin');
            loadingEl.classList.remove('hidden');
            loadingEl.classList.add('flex');
            errorEl.classList.add('hidden');
            contentEl.style.opacity = '0.5';
            contentEl.style.pointerEvents = 'none';

            try {
                const url = SHEET_URL + '&t=' + Date.now();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

                const csvText = await response.text();
                if (!csvText.trim()) throw new Error('La respuesta del servidor está vacía');

                const data = parseCSV(csvText);
                allData = data;
                processData(data);
                document.getElementById('last-update').textContent = new Date().toLocaleString('es-AR');
                errorEl.classList.add('hidden');

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('error-message').textContent = err.message;
                errorEl.classList.remove('hidden');
            } finally {
                loadingEl.classList.add('hidden');
                loadingEl.classList.remove('flex');
                contentEl.style.opacity = '1';
                contentEl.style.pointerEvents = 'auto';
                refreshIcon.classList.remove('fa-spin');
            }
        }

        // ============================================================
        // Procesar y renderizar
        // ============================================================
        function processData(data) {
            document.getElementById('kpi-total').textContent    = data.length;
            document.getElementById('kpi-stores').textContent   = new Set(data.map(d => d.tienda)).size;
            document.getElementById('kpi-products').textContent = new Set(data.map(d => d.producto)).size;

            const avg = data.reduce((s, d) => s + d.porcentaje, 0) / data.length;
            document.getElementById('kpi-diff').textContent = avg.toFixed(1) + '%';

            const critical = data.filter(d => d.porcentaje > 20).length;
            const medium   = data.filter(d => d.porcentaje >= 10 && d.porcentaje <= 20).length;
            const low      = data.filter(d => d.porcentaje < 10).length;

            document.getElementById('count-critical').textContent = critical;
            document.getElementById('count-medium').textContent   = medium;
            document.getElementById('count-low').textContent      = low;

            // Chart tiendas
            const storeCounts = {};
            data.forEach(d => { storeCounts[d.tienda] = (storeCounts[d.tienda] || 0) + 1; });
            const topStores = Object.entries(storeCounts).sort((a,b) => b[1]-a[1]).slice(0,10);
            updateChart('storesChart', 'bar', {
                labels: topStores.map(s => s[0].length > 18 ? s[0].slice(0,16)+'…' : s[0]),
                datasets: [{ data: topStores.map(s => s[1]), backgroundColor: '#3b82f6', borderRadius: 6 }]
            }, { indexAxis: 'y', plugins: { legend: { display: false } } });

            // Chart productos
            const prodCounts = {};
            data.forEach(d => { prodCounts[d.producto] = (prodCounts[d.producto] || 0) + 1; });
            const topProds = Object.entries(prodCounts).sort((a,b) => b[1]-a[1]).slice(0,8);
            updateChart('productsChart', 'bar', {
                labels: topProds.map(p => p[0].length > 22 ? p[0].slice(0,20)+'…' : p[0]),
                datasets: [{ data: topProds.map(p => p[1]), backgroundColor: '#f59e0b', borderRadius: 6 }]
            }, { plugins: { legend: { display: false } } });

            // Chart severidad
            updateChart('severityChart', 'doughnut', {
                labels: ['Crítico', 'Medio', 'Bajo'],
                datasets: [{ data: [critical, medium, low], backgroundColor: ['#ef4444','#f59e0b','#10b981'], borderWidth: 0 }]
            }, { cutout: '70%', plugins: { legend: { display: false } } });

            // Alertas
            const alertsEl = document.getElementById('alerts-container');
            alertsEl.innerHTML = '';
            const topAlerts = data.filter(d => d.porcentaje > 15).sort((a,b) => b.porcentaje-a.porcentaje).slice(0,5);
            if (topAlerts.length === 0) {
                alertsEl.innerHTML = '<p class="text-slate-500 text-sm">No hay alertas críticas activas.</p>';
            } else {
                topAlerts.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-3 rounded-lg bg-slate-800/50 border border-slate-700';
                    div.innerHTML = `
                        <div class="w-2 h-2 rounded-full flex-shrink-0 ${c.porcentaje > 20 ? 'bg-red-500' : 'bg-amber-500'}"></div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white truncate">${c.tienda}</p>
                            <p class="text-xs text-slate-400 truncate">${c.producto}</p>
                        </div>
                        <div class="text-right flex-shrink-0 flex items-center gap-2">
                            <p class="text-sm font-bold ${c.porcentaje > 20 ? 'text-red-400' : 'text-amber-400'}">-${c.porcentaje.toFixed(1)}%</p>
                            ${c.link ? `<a href="${c.link}" target="_blank" class="link-btn"><i class="fas fa-external-link-alt text-[10px]"></i> Ver</a>` : ''}
                        </div>
                    `;
                    alertsEl.appendChild(div);
                });
            }

            renderTable(data);
        }

        function updateChart(canvasId, type, data, options) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();
            const isCartesian = type !== 'doughnut' && type !== 'pie';
            charts[canvasId] = new Chart(ctx, {
                type, data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    ...options,
                    scales: isCartesian ? {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                    } : {}
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">No hay resultados.</td></tr>';
                return;
            }

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-800/50 transition-colors';

                let sClass = 'severity-low', sText = 'Baja';
                if (row.porcentaje > 20)       { sClass = 'severity-high';   sText = 'Crítica'; }
                else if (row.porcentaje >= 10) { sClass = 'severity-medium'; sText = 'Media'; }

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white">${row.tienda}</td>
                    <td class="px-6 py-4 text-slate-300 text-xs">${row.producto}</td>
                    <td class="px-6 py-4 text-right text-slate-300">$${row.precioMin.toLocaleString('es-AR')}</td>
                    <td class="px-6 py-4 text-right text-slate-300">$${row.precioVenta.toLocaleString('es-AR')}</td>
                    <td class="px-6 py-4 text-right font-semibold text-red-400">
                        -$${Math.abs(row.diferencia).toLocaleString('es-AR')} (${row.porcentaje.toFixed(1)}%)
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${sClass}">${sText}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        ${row.link
                            ? `<a href="${row.link}" target="_blank" rel="noopener" class="link-btn">
                                <i class="fas fa-external-link-alt text-[10px]"></i> Ver
                               </a>`
                            : '<span class="text-slate-600 text-xs">—</span>'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterTable() {
            const search   = document.getElementById('search-input').value.toLowerCase();
            const severity = document.getElementById('filter-severity').value;
            const filtered = allData.filter(row => {
                const matchSearch = row.tienda.toLowerCase().includes(search) || row.producto.toLowerCase().includes(search);
                let matchSev = true;
                if      (severity === 'high')   matchSev = row.porcentaje > 20;
                else if (severity === 'medium') matchSev = row.porcentaje >= 10 && row.porcentaje <= 20;
                else if (severity === 'low')    matchSev = row.porcentaje < 10;
                return matchSearch && matchSev;
            });
            renderTable(filtered);
        }

        function sortTable(column) {
            if (sortState.column === column) sortState.asc = !sortState.asc;
            else { sortState.column = column; sortState.asc = true; }
            allData.sort((a, b) => {
                const va = typeof a[column] === 'string' ? a[column].toLowerCase() : a[column];
                const vb = typeof b[column] === 'string' ? b[column].toLowerCase() : b[column];
                return sortState.asc ? (va < vb ? -1 : va > vb ? 1 : 0) : (va > vb ? -1 : va < vb ? 1 : 0);
            });
            filterTable();
        }

        window.addEventListener('load', loadData);
    </script>
</body>
</html>
